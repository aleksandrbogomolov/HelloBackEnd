# HelloBackEnd

[![Build Status](https://travis-ci.org/aleksandrbogomolov/HelloBackEnd.svg?branch=master)](https://travis-ci.org/aleksandrbogomolov/HelloBackEnd)

REST сервис HelloBackEnd

Сервис - Spring Boot 1.4.1.  
SQL БД - PostgreSQL 9.4.1211.  
Сборка - Maven.  
Интеграционные тесты -  используется библиотека [REST Assured](http://rest-assured.io).

Для работы приложения необходима БД **helloBackEnd**. Настройки доступа расположены в файле **/resources/application.yml**.   
Таблица **contacts** имеет два поля  
id - 64 bit integer  
name - varchar  
, инициализация и заполнение выполняются автоматически при старте приложения или тестов. Скрипты **schema.sql** и **data.sql** расположены в директории **resources**.

Для обработки множества запросов в файл **/resources/application.yml** добавлены настройки **Tomcat connection pool**.

Пример запроса к таблице **contacts**: 

__/hello/contacts?nameFilter=^A.*$&lastId=0&limit=5__

Запрос  возвращает контакты из таблицы БД. Массив контактов возвращается в json формате.
  
Параметр **nameFilter** обязателен. В него передаётся регулярное выражение. В возвращаемых данных нет записей, в которых contacts.name совпадает с регулярным выражением, фильтрация производится в приложении на уровне service layer.
  
Параметры **lastId** и **limit** добавлены для исключения единовременной загрузки большого количества данных из БД и порционной выборки данных, данные параметры не обязательны в строке запроса, при их отсутсвии заполнение происходит при формировании запроса к БД предустановленными значениями. Для загрузки следующей порции данных необходимо использовать параметр **lastId**, например **lastId=15** выберет следующий набор данных начиная с 6 строки.

 
Для запуска приложения на локальном компьетере необходимо создать в PostgreSQL БД **"helloBackEnd"**, склонировать данный [репозиторий](https://github.com/aleksandrbogomolov/HelloBackEnd.git), в файле **/resources/application.yml** изменить **username** и **password** для доступа к созданной локальной базе, перейти в терминале в созданный каталог и выполнить команды **mvn package** и **java -jar target/hellobackend-0.0.1-SNAPSHOT.jar**.     

Примеры запросов  
[http://localhost:8080/hello/contacts?nameFilter=^A.\*$&lastId=0&limit=5](http://localhost:8080/hello/contacts?nameFilter=^A.\*$&lastId=0&limit=5) - возвращает часть контактов, которые НЕ начинаются с A.  
[http://localhost:8080/hello/contacts?nameFilter=^.*[ai].*$&lastId=0&limit=5](http://localhost:8080/hello/contacts?nameFilter=^.*[ai].*$&lastId=0&limit=5) - возвращает часть контактов, которые НЕ содержат букв a, i.

Запуск приложения с использованием **Vagrant**. Создать отдельную папку для проекта, например **workspace**, склонировать в данную папку [репозиторий](https://github.com/aleksandrbogomolov/HelloBackEnd.git), перенести файлы **Vagrantfile** и **vagrant_provision.sh** из корня проекта в корень папки **workspace**. Перейти в терминале в папку **workspace**, выполнить команду **vagrant up**, после запуска виртуальной машины подключится к ней выполнив команду **vagrant ssh**, перейти в каталог с проектом **cd vagrant/HelloBackEnd** выполнить его сборку **mvn package** и после окончания сборки запустить **java -jar target/hellobackend-0.0.1-SNAPSHOT.jar**. 
  
Примеры запросов для Vagrant  
[http://192.168.33.10:8080/hello/contacts?nameFilter=^A.\*$&lastId=0&limit=5](http://192.168.33.10:8080/hello/contacts?nameFilter=^A.\*$&lastId=0&limit=5) - возвращает часть контактов, которые НЕ начинаются с A.  
[http://192.168.33.10:8080/hello/contacts?nameFilter=^.*[ai].*$&lastId=0&limit=5](http://192.168.33.10:8080/hello/contacts?nameFilter=^.*[ai].*$&lastId=0&limit=5) - возвращает часть контактов, которые НЕ содержат букв a, i.

Устраненные замечания и изменения.

* String.matches, каждый раз при использовании заново обрабатывает регулярное выражение, замена на __java.util.regex.Pattern__.

* Изменен статус при невалидном регулярном выражении на __NOT_FOUND__.

* Добавлена проверка на превышение пользователем лимита запрошенных данных с отправкой статуса __BAD_REQUEST__.

Изменена логика получения данных, так как предыдущая реализация допускала отправку пустых ответов. Текущая реализация проверяет количество отфильтрованых строк и при необходимости делает дополнительные запросы до необходимого лимита. При возврате из БД пустого ответа пользователю возвращается статус __NOT_FOUND__. 

Параметр __offset__ заменен на __lastId__. Параметр __lastId__ не обязателен, но при его отсутсвии будет выдаваться только первая часть результата. Логика использования данного параметра - при первой загрузке страницы он равен __0__, в дальнейшем при уже имеющихся данных в следующем запросе он равен максимальному __id__, отображенному на странице, полученному например с использованием __tr:nth-last-child__. Так же данный параметр может быть изменен вручную в строке запроса, или средствами управления на странице, для перехода к конкретному существующему __id__, это единственый способ произвольного досупа к конкретной части результата, так как данная реализация дает возможность только последовательного перехода между страницами таблицы.  

Для уменьшения количества запросов к БД при подготовке очередной партии результатов можно ввести дополнительный коэффициент для увеличения количества сырых данных например жестко зафиксировав его в параметре метода __repository.getLimitAll(lastId, limit * 2)__. 

Или как более гибкий вариант добавить поле типа __Map\<String, Integer\> rates__, в котором в качестве ключей будут хранится все когда либо использованые пользователями регулярные выражения, а значения будут использоваться как коэффициент при запросе и при необходимости корректировки изменяться в большую или меньшую сторону. Таким способом при определенной наработке можно свести к минимуму количество запросов и количество сырых данных передаваемых из БД.